
module.exports = function(Gamify) {
	
	var mongo	= new Gamify.mongo({database:Gamify.settings.db});
	mongo.init(function() {
		
	});
	
	var caching = function(ttl) {
		this.ttl 	= ttl;
		this.cache 	= {};
		var scope = this;
		setInterval(function() {
			var i;
			var t = new Date().getTime();
			for (i in scope.cache) {
				if (scope.cache[i].expires < t) {
					delete scope.cache[i];
				}
			}
		}, this.ttl/2);
	};
	caching.prototype.set = function(label, value) {
		//Gamify.log("set()", [label, value]);
		var expires = new Date().getTime()+this.ttl;
		this.cache[label] = {
			data:		value,
			expires:	expires
		}
		return expires;
	}
	caching.prototype.get = function(label) {
		if (this.cache[label]) {
			return this.cache[label].data;
		}
		return null;
	};
	caching.prototype.clear = function(label) {
		delete this.cache[label];
	};
	
	var cache = new caching(1000*20);	// 20sec session caching
	
	return function(req, res, next) {
		//Gamify.log(">> COOKIE", req.cookies.session_key);
		if (req.user && !req.cookies.session_key) {
			// Set the session cookie
			res.cookie('session_key', req.user.apikey, {
				path:	'/',
				maxAge: 1000*60*60*24*14
			});
		}
		if (req.cookies.session_key) {
			// Make sure the user is right
			var cached = cache.get(req.cookies.session_key);
			//Gamify.log(">> cached", cached);
			if (cached != null) {
				req.user = cached;
				next();
			} else {
				mongo.find({
					collection:	"users",
					query:	{
						apikey:	req.cookies.session_key
					}
				}, function(response) {
					if (response.length == 0) {
						// Remove the cookie
						res.clearCookie('session_key');
						// empty the user session
						req.user = null;
						next();
					} else {
						cache.set(req.cookies.session_key, response[0]);
						req.user = response[0];
						Gamify.log(">> req.user", req.user != null);
						next();
					}
				});
			}
		} else {
			next();
		}
	};
};
